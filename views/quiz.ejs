<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Node.js課題3</title>
</head>
<body>
    <h1 id="title">問題</h1>
    <div id="generate">
        <h4>[ジャンル]   </h4>
        <h4>[難易度] </h4>
    </div>
    <p id="question">以下のボタンをクリック</p>
    <div id="choicesList"></div>
</body>
<script>
    title = document.getElementById('title');
    question = document.getElementById('question');
    choicesList = document.getElementById('choicesList');
    generate = document.getElementById('generate');

    let questionArray = [];
    let correctAnswerArray = [];
    let incorrectAnswerArray = [];
    let categories = [];
    let difficulties = [];
    let shuffleChoices = [];
    let choices = [];
    const ALL_QUIZ_COUNT = 10;//出題問題数

    let questionNumber =  window.sessionStorage.getItem([`questionNumber`]);
    let numberOfCorrectAnswers =  window.sessionStorage.getItem([`numberOfCorrectAnswers`]);
    questionNumber = parseInt(questionNumber);
    numberOfCorrectAnswers = parseInt(numberOfCorrectAnswers);

    //セッションからクイズデータを
    for (let i = 0 ; i < 10 ; i++) {
        questionArray[i] = window.sessionStorage.getItem([`questions${i}`]);
        correctAnswerArray[i] = window.sessionStorage.getItem([`correctAnswers${i}`]);
        incorrectAnswerArray[i] = window.sessionStorage.getItem([`incorrectAnswers${i}`]);
        categories[i] = window.sessionStorage.getItem([`categories${i}`]);
        difficulties[i] = window.sessionStorage.getItem([`difficulties${i}`]);
    }
    //console.log("questionArray", questionArray);
    console.log("correctAnswerArray", correctAnswerArray);
    console.log("incorrectAnswerArray", incorrectAnswerArray);
    //console.log("categories", categories);
    //console.log("difficulties", difficulties);
    

    //選択肢をシャッフルするため
    const shuffle = ([...array]) => {
        for (let i = array.length - 1; i >= 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    //クイズを画面に表示
    //問題番号・ジャンル・難易度・問題文をつくる。
    titleNumber = questionNumber + 1;
    title.innerHTML = '問題' + titleNumber
    generate.innerHTML = 
    '<h4>' + '[ジャンル] ' + categories[questionNumber] + '</h4>' +
    '<h4>' + '[難易度] ' + difficulties[questionNumber] + '</h4>'
    question.innerHTML = questionArray[questionNumber];

    //正解と不正解の選択肢を１つの配列に一緒に格納する。
    choices.push(correctAnswerArray[questionNumber]);

    incorrectArray = incorrectAnswerArray[questionNumber].split(",");
    incorrectArray.forEach(function (incorrectAnswer) {
        choices.push(incorrectAnswer);
    });
    //選択肢の順番をシャッフル
    shuffleChoices = shuffle(choices);

    //それぞれの選択肢ボタンをつくる。
    shuffleChoices.forEach(function (one_choice) {
        const tr = document.createElement("tr");
        tr.innerHTML = '<td>' + '<button class=answer>' + one_choice + '</button>' + '</td>';
        choicesList.appendChild(tr);
    })

    answerBtn = document.getElementsByClassName('answer')
    for (let n = 0 ; n < answerBtn.length ; n++) {
        answerBtn[n].setAttribute("onclick", "select("+n+")");//setAtributeのidで実装できなかった
    };

    //選択肢にアンサーしたとき
    function select (n) {
        //選択が正解ならば
        if (shuffleChoices[n] === correctAnswerArray[questionNumber]) {
            numberOfCorrectAnswers += 1;
            console.log("正解")//確認用
        }else{
            console.log("不正解")//確認用
        }
        choices = [];//選択肢を空にする
        choicesList.innerHTML = "";//選択肢のレンダリングを空にする

        questionNumber += 1;//問題を次のステップの番号に
        window.sessionStorage.removeItem([`questionNumber`]);
        window.sessionStorage.removeItem([`numberOfCorrectAnswers`]);
        window.sessionStorage.setItem([`questionNumber`], questionNumber);
        window.sessionStorage.setItem([`numberOfCorrectAnswers`], numberOfCorrectAnswers);

        //問題番号が出題数を満たした場合、結果発表へ
        if (questionNumber === ALL_QUIZ_COUNT) {
            location.href=`http://localhost:3000/quiz/result`
        } else {
            location.href=`http://localhost:3000/quiz/id=${questionNumber + 1}`
        }
    };



    
</script>
</html>